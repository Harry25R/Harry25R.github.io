import{getPublications as e,getTalks as t}from"./data.js";import{escapeHTML as n}from"./utils.js";export async function initModal(o=document){const a=o.querySelector("[data-modal-root]"),r=a?.querySelector("template#modal-template"),l=Array.from(o.querySelectorAll("[data-modal-trigger]"));if(!a||!r||0===l.length)return;const[d,s]=await Promise.all([e(),t()]);let i=null,c=[],u=null;const p=()=>{u&&(u.remove(),u=null),a.hidden=!0,document.removeEventListener("keydown",f,!0),i&&(i.focus(),i=null)},f=e=>{if("Escape"===e.key)return e.preventDefault(),void p();if("Tab"===e.key&&c.length){const t=c[0],n=c[c.length-1];e.shiftKey&&document.activeElement===t?(e.preventDefault(),n.focus()):e.shiftKey||document.activeElement!==n||(e.preventDefault(),t.focus())}};l.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const o=e.dataset.modalContent;if(!o)return;i=e;const l=e.closest("[data-publication]"),m=e.closest("[data-talk]");let h="<p>Additional details will be published soon.</p>";if(l){const e=d.find(e=>e.title===o);e&&(h=(e=>{const t=[];e.doi&&t.push(`<a class="text-brand hover:underline" href="https://doi.org/${encodeURIComponent(e.doi)}" target="_blank" rel="noopener">View DOI</a>`),e.pdf&&t.push(`<a class="text-brand hover:underline" href="${n(e.pdf)}" target="_blank" rel="noopener">Download PDF</a>`),e.code&&t.push(`<a class="text-brand hover:underline" href="${n(e.code)}" target="_blank" rel="noopener">View code</a>`);const o=`<p>${n(e.abstract||"Abstract coming soon.")}</p>`;return t.length?`${o}<p class="flex flex-wrap gap-3 text-sm font-medium">${t.join("")}</p>`:o})(e))}else if(m){const e=s.find(e=>e.title===o);e&&(h=(e=>{const t=[];e.slides&&t.push(`<a class="text-brand hover:underline" href="${n(e.slides)}" target="_blank" rel="noopener">Slides</a>`),e.video&&t.push(`<a class="text-brand hover:underline" href="${n(e.video)}" target="_blank" rel="noopener">Watch recording</a>`);const o=`<p>${n(e.summary||"Session summary available on request.")}</p>`;return t.length?`${o}<p class="flex flex-wrap gap-3 text-sm font-medium">${t.join("")}</p>`:o})(e))}((e,t)=>{a.hidden=!1,u=r.content.firstElementChild.cloneNode(!0);const n=u.querySelector("#modal-heading"),o=u.querySelector("[data-modal-body]");n.textContent=e,o.innerHTML=t,u.querySelector("[data-modal-close]")?.addEventListener("click",p),a.appendChild(u),c=Array.from(u.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])')),c[0]?.focus(),document.addEventListener("keydown",f,!0)})(o,h)})})}